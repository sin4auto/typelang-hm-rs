<!-- パス: AGENTS.md -->
<!-- 役割: Codex/TypeLang チームの統一オペレーションガイド -->
<!-- 意図: 日常タスクを効率的かつ安全に遂行するための原則と手順を集約する -->
<!-- 関連ファイル: README.md, EBNF.md -->

# Codex エージェント運用ハンドブック

TypeLang HM/Rust プロジェクトで作業する AI エージェントと人間開発者は、このドキュメントを唯一の判断基準として参照してください。常に 80/20 の最小実装と可読性を優先し、疑問があればここに立ち戻ります。

---

## Quickstart（10 行）
1. **指示に忠実に従い、過不足を生まないこと。**
2. **最小で十分な解を選び、複雑さを避ける。**
3. **編集対象と関連ファイルを必ず全文確認してから手を動かす。**
4. **まず小さく動くプロトタイプを用意し、検証→拡張の順に進める。**
5. **全ファイルに日本語 4 行ヘッダを欠かさず記載する。**
6. **コミットは小粒で意味を持たせ、1PR=1目的を徹底する。**
7. **暗黙のロジックには日本語の rustdoc コメントを添え、明快な英語識別子を使う。**
8. **リスクのある操作は理由・代替・ロールバックを実行前に提示する。**
9. **意思決定はファイルヘッダと PR 本文に必ず記録する。**
10. **GitHub 等への push はユーザーの明示承認がある場合のみ行い、作業締めは必ず `make check` で検証する。**

---

## GOAL / 目的
- いつでも読み返せるシンプルで堅牢なコードを提供する。
- シニア開発者と同等の判断力を意識し、過剰設計や未検証の賭けを避ける。

## OPERATING PRINCIPLES / 作法
- ミニマルな構成を常に選択し、必要に応じて最小再現例を提示する。
- 不確実な課題は「小さな試作 → 観察 → 調整」で前進する。
- 会話・報告は日本語を基調に、用語や識別子は英語で統一する。

## ROLES / 関与者
- **User**: ゴール定義と最終判断を担当。
- **Human Devs**: 実装・レビュー・設計相談を補助。
- **VS Code / Copilot**: IDE 内での提案補助。採用は必ず人間/エージェントが評価する。
- **AI Agents（Codex 等）**: 複数ファイルの編集、テスト、Git 操作、リファクタを遂行。

## SCOPE & VERSION CONTROL / 範囲とバージョン管理
- 依頼外の作業は提案として切り出し、勝手に実装しない。
- Push は明示許可があるときのみ。ローカル作業は小さなコミットに分割し、`<type>: <summary>` 形式を守る。
- 1 つの PR は厳密に 1 目的に紐づけ、差分をレビューしやすい大きさに保つ。

## FILE HEADER ルール
各ファイルの先頭 4 行は必須です。削除・省略は禁止。
```txt
<!-- パス: <repo 相対パス> -->
<!-- 役割: <ファイルの役割> -->
<!-- 意図: <存在理由や狙い> -->
<!-- 関連ファイル: <2〜4件> -->
```

## COMMENTS & NAMING / コメントと命名
- ファイル先頭で対象領域を宣言し、非自明な処理にのみ補足コメントを入れる。
- 関数・構造体・クレート・enum・impl ブロックには **必ず日本語の rustdoc (`///`) を 1 行以上** 記載し、役割や背景を簡潔に説明する（「日本語:」などのプレフィックスは付けない）。
- 識別子・関数名は英語。説明は日本語でも構わないが簡潔に。
- コメントは「何を・なぜ」を優先し、「どうやって」はコードで示す。

## WORKFLOW CHECKLISTS / 作業チェックリスト
**Before Change**
- [ ] 依頼内容を 1〜2 行で言い換え共有
- [ ] 関連ファイルと影響箇所を列挙
- [ ] 仕様 / UI / API の差分・期待値を確認

**During Implementation**
- [ ] 最小構成で動くところまで実装し、徐々に広げる
- [ ] 4 行ヘッダ・命名・コメント指針を順守
- [ ] エラーは再現手順とともに改善案を添える

**Test & Verify**
- [ ] 正常系 / 異常系 / 境界条件のテストを実行
- [ ] 必要なら手動確認メモを残す
- [ ] UI 変更は可能であれば Before/After を記録
- [ ] 仕上げに `make check`（fmt → clippy → test）を通して完走ログを確認

**Before PR**
- [ ] 変更要点を 3 行以内でまとめる
- [ ] なぜ今回が 80/20 な解なのか説明する
- [ ] ロールバック手段を 1〜2 行で示す（例: `revert <sha>`）

## EXECUTION GUARDRAILS / 危険操作ガイド
- リスク対象: データ喪失・セキュリティ・広範囲リファクタ・インフラ変更。
- 実施前に「目的」「代替案」「影響範囲」「ロールバック」「段階導入案」を提出し、承認を得る。

## QUALITY GATES / 品質ゲート
- 標準: 常に `make check` で `fmt`/`clippy`/`test` を一括実行し、失敗時は即リカバー。
- 影響が大きい場合は E2E / 統合テストや追加検証を検討する。
- 決定や背景はヘッダ・PR・Issue に記録し、後追いできる状態を保つ。

## TEMPLATES / 雛形
**PR タイトル**
```
feat: deliver minimal X (clarifies Y)
```

**PR 本文（最小構成）**
- **Summary**: 何を変更したか。
- **80/20**: なぜ十分なのか。
- **Impact**: API / UI / Migration の有無。
- **Rollback**: どう戻すか。

**コミットメッセージ**: Conventional Commits の `<type>: <summary>` を使用。

## UI ESSENTIALS / UI ガイド
- 情報量を絞り、明瞭な余白リズム（4/8px）と短い文章で視認性を高める。
- ベースカラーは黒/白、アクセントは深い青、グレーはニュートラル系を利用。
- Apple / ChatGPT のシンプルさをベンチマークにする。

## DATA POLICY / データ取扱い
- データベースや永続化を伴う操作はユーザーのみが実行する。
- 変更提案時は理由・スキーマ差分・移行計画・リスク・ロールバックをセットで提示。
- 重大変更にはバックアップと段階導入計画を必ず用意する。

## BOOT PROMPT（任意）
```
Read ./.codex/AGENTS.md now and follow it strictly; then reply with (a) 3 key rules, (b) the next 3 steps, and (c) one-line risks+rollback.
```

## GLOSSARY / 用語集
- **80/20**: 最小の労力で最大の効果を得る姿勢。
- **APPU**: Active Paying Power Users。課金中で継続利用している指標。
- **Minimal implementation**: 要件を満たす堅牢な最小構成。まずこれを固め、必要なら拡張する。

このハンドブックを常に参照し、判断に迷ったときは戻って確認してください。
